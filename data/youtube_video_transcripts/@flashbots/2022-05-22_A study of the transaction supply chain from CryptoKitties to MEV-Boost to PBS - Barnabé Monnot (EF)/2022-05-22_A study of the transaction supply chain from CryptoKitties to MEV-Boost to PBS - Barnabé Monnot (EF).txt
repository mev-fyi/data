[Music] let's get started hi everyone my name is barnabe mono i'm a researcher at the robust incentives group which is a research team at the ethereum foundation i got nerd sniped pretty late to give this talk and i wasn't sure what to talk about so i put a lot of things in the title and i and i think you'll find that some some of it is interesting i hope in this room there's been a lot of history or people reminiscing about the good times when you know it was simple to get access to a blog you would just ask the block producer kindly please let me in and the block producer would say yes and you would just enter for a very low fee and the theme of the day is how mev ruined all of this but actually before mev congestion ruined this you started breeding crypto kitties suddenly the block was full there was no space for you users had to raise their prices that was difficult so how did we solve that i'll get to that in a sec but today what i want to get at is that ethereum is this weird big complex economic system where users have their own economic interests they have digital assets they have some value for using the chain and so they're going to find ways to increase their payoff and to increase the economic utility that they get from transacting on ethereum and that downstream leads to changes in the market structure of how we access block space and as a reminder block space is what ethereum sells and we can let the market for block space figure out its best incarnation or we can try and move systemic mechanisms to the protocol and so one theme of my talk today is to try and get at you know why do we want some parts of the market in protocol versus some parts outside of it to understand that i think it's kind of useful to understand what users want exactly so there's been a lot of talks about preferences and i am going to try and make it a little more formal so you can think of users as having a utility per gas i denote it by v so you can say well one unit of gas is worth v to me the dollars or the grey and the goal of the market is to find the entry price that equalizes the supply of block space with a demand for it given this series of user utilities so you might have several users showing up your market each user has a different willingness to pay how do you organize this allocation well eip1559 solves it right you can order these users by their willingness to pay that gives you a very neat demand curve eip1559 targets the midpoint where the block is half full at 15 million gas most of the time the estimation is pretty good and and this estimation is done by the base fee which is floating and gives you the protocol uh mandated entry price and this achieves economic efficiency right you let the users that have the highest utility for using the chain in and you keep out the ones that are not so willing to to pay for it yeah and so you achieve the highest sum of these utilities that are pending on top of this maybe some arguments for why such a mechanism was nice to have in the protocol is that first it gave us an economically secure oracle for the inclusion price right before we relied on gas oracles it's fairly clear that they weren't too tampered with but it's also not very hard to to do so if you are really willing to send or to to stuff your transaction pool with spam transactions if you have a miner who's operating them with eip1559 it's much harder for for someone to to make the price biased or at least it's economically wasteful for for that party something that's maybe even more important for protocol security is that transaction fees are an incentive to reorganize the chain if they are high enough and by removing part of these transaction fees so the base fee that's burnt we removed that subsidy for re-orgs and on top of this we also removed the rent that miners were extracting from congestion and that rent is now redistributed to the ethereum holder community it's also nice but it improved ux now that we have this block slack the demand shocks can be dampened and users have a better time estimating the fee that they need to pay to to get in so are we done did we solve the free market bob is super cool but you know that we haven't and one clue for why we haven't is reversions right so i told you users have this utility v but sometimes things happen that you didn't mean for them to you wanted to meet an nft you sent your transaction to a transaction pool you said please contract give me one nft but by the time you were included the contract had run out of of nfts to to give you and so this is a picture from a blog that was after an nft sale most of the transactions are just reverted because these are users who are not included in time and the contract had run out of items and so these three versions they tell you that you know sometimes things happen and it's out of your control and so maybe you don't have a preference for gas you don't have a utility per gas but what you have is more like a utility per gas per state so your utility for the unit of gas it depends on the state that your transaction is acting upon and the state might change in the meantime so your utility to get an nft when the state is not everything has been minted it might be a million dollars but your utility when the state is there's no more nfcs to sell it's now zero okay and so what this tells us is that transactions are not atomic and we can't think of them as living in their own isolated parallel universes the utility of a transaction depends not just on its inclusion but also on its position and position is just another way of saying that it depends on the state that it acts upon this is all well known but i i'm just trying to get there from first principles and so what do we do in this case in in this case the auction mechanism we have which is eap1559 it's an auction mechanism that works well when we have preferences over items or when the block space is fungible when i don't care to be in one part of the block space versus another but now we have to think about preferences over bundles and this is much more complicated because it makes the block space not fungible and it also leads to this explosion of complexity in terms of you know how many bundles exist and how user preferences map to all of these blenders so if i wanted to represent this these transactions i could do it in the in the following way i think of a block as a set of transactions i use these stars here as like a wild card kind of like a regular expression and this for instance in the first line is the preference of a user that doesn't really care about its position you just want its transaction to be to be included the second line would tell you this is a user that really care about the post state of transaction prime and so they want to be included right after it and they don't really care what's happening on either side and so you can write these preferences down with preferences of your bundles but when you do so you kind of lose the mental model of the demand curve it's not that neat one-dimensional thing anymore you have these preferences over a very complex domain of bundles and the solution for this if you don't have this demand curve and you can't have a computationally simple mechanism to to find the optimal allocation you let the market figure out these opportunities and you let the market pay for the information that you know this bundle is valuable and there's more need to be extracted from it or for the users to to receive and so this leads us to flashbots which was kind of a market reply to this problem that there was no way for users to express their preferences otherwise other than pgas but even pgas are let's say a market response to to the lack of infrastructure and protocol to to do that and so if i want to background a transaction for instance there's tx is an oracle update and i want to liquidate something that comes right after it i really have a utility for getting my transaction right after this let's say a million dollar but if someone else manages to slide in the middle then my utility is zero and so the idea of flash bots and bundling was well how about then letting me bid for this atomic bundle transaction and my background atomically and so this is flashback bundles the searchers send bid to the block producer to get their bundles included and so now we add an element to our transaction supply chain how did that work pre-merge which is proof-of-work which is today but sometimes when you do a lot of research on proof-of-stake you you already feel like this is this has happened but not yet so pre-merge bundles leak alpha and when searchers send their bundles to the block producers they don't want the blog producers to to receive to steal the contents of the bundle and so the flashbot solution was to white list trustworthy miners but that won't steal the bundles and the bundles can receive this information and include them in their own blocks it's not great but at the same time the white list is pretty short because most miners in ethereum join mining pools so if you give the bundles to the mining pool you can kind of ensure that you know you have identifiable players that won't behave maliciously and another thing is you can also pressure these identifiable players to to redistribute the the profit they make from getting the bundles with their user base and so to some extent you avoid the bad dystopia of economic centralization and you add something else to your transaction supply chain miv gaff in the middle what happens when we move to proof of stake in proof of stake we have an issue it's a feature of proof of stake but it's an issue for that system which is that we have a long tail of solo validators the reward variance is much smaller validators get paid every six minutes and so there's a lot of solo validators that decide that they don't want to join a stanky staking pool and they will just take themselves but the problem is we can't whitelist everyone and we don't have identifiable players and these validators who are solo validators they don't propose blogs very often and so they might have an incentive to deviate from an agreed upon common social norm that you don't steal bundles because they really don't play a repeated game only once in a while activate to propose a block so if you only share the alpha with the trusted validators you are back to the economic centralization bad case so one solution you could think is what about blind proposing so you make proposals commit to a bundle header you say there's a juicy bundle here commit to including it and i will share it with you later um but the problem with that is that it's not really compatible with searchers doing one part of the block so the top end usually and proposals doing the other part if the proposals don't know what researchers are going to give them they might be including duplicate transactions and if they do commit to something which is then revealed and then they do their block it gives them time to extract more mv and so it again leads us to a situation where the proposals need to be very sophisticated actors and to more centralization and so that's not really optimal either and so the solution that we've arrived at is instead to extend the auction and to let builders propose whole blocks and so we add another element to our transaction supply chain and and the current proposal uh post merge is is by flashbots and i will run through quickly on on the basics of how it works in this proposal the builders make blocks and they submit the blocks and the bid so they save his block i'm willing to pay x to be included by the proposer they submit the block and the bid to the relay so the relay is a new third party in that system the relay receives these blocks and these bids and it sends the list of bids to the proposal it doesn't send the blocks obviously and then the proposal is tasked to choose the bid that they prefer so i would expect they would choose the the highest bid they sign that bid they say you know i like that bid send that back to the relay and at this point because the validator signed something that commits them to releasing a specific block the relay could simply gossip the block that they have in custody with with a validator signature and so now the question is interesting right we have this all this transaction supply chain that emerges out of protocol and where do we draw the line for what the protocol should be concerned with i'll get to that in a second but the first id is to at least move a relay into the protocol and so this is the id of pbs which is still under active research proposal builder separation move in protocol the auction for these execution block bodies at the moment i believe the two slot design seems the most workable so the basic idea is this instead of having single beacon blocks you you think of a slot now as being split in half in the first block the proposer commits to some to some block header that they received of band from the from the builder so the proposer sends a beacon block saying i commit to using this builder's block in the second slot the builder is expected having seen the commitment of a proposal to send the body of their of their block we apply the third choice to to both blocks and that ensures that none of these parties can grieve one another for instance if the builder doesn't show up and doesn't release the content of their of their block the proposal would still get paid it doesn't waste the opportunity for for the proposal and on the other hand the builder needs to know that there has been a commitment from the proposal and that this commitment is has been agreed upon by the by the other validators so if the builder doesn't see a commitment from the proposer they don't release their block and they keep it private and they don't leak the the alpha yet and so what are the benefits and the drawbacks of in protocol pbs and and out of protocol mev boost so i think one of the main benefit is that we remove this third party which is the relay uh from the picture one issue with a relay for instance is that you might have a liveness fault you might have a proposal that signs something and then for some reason even if the relay is decentralized some something goes down uh and and the proposer has signed something so they are unable to to send a different block but at the same time the block they signed they it's not been released um to the to the network another part is that the builders must also trust the relays to not steal the content of their block whereas in pbs the builder is the one keeping private the content and releasing it when it's appropriate another benefit of pbs is that the relay does not become a rent-seeking entity so relays are going to compete over the quality of service they can they can provide um and and make a profit out of it and so this this is something that we we can move to to the protocol instead another nice thing is that the builder role we can exploit it positively for other constructions such as tank sharding so there are there's a new philosophy that you know block creation can be expensive as long as block validation uh remains cheap and so bank sharding has requirements for bandwidth for the size of the blocks that that will be built and so if we have very specialized builders that can invest in good hardware we can use that for for the process of block creation some of the drawbacks the first is that it does enshrine a kind of market structure and i think it would be nice to have maybe impossibility result or at least a sense that you know this mechanism is on some efficient frontier uh yesterday at economics we had a talk by tim rovgarden and he was reminding us that like eip1559 is is pretty close to the efficient frontier like if you remove anything from it it it doesn't work or if you try to make it better on some dimension you're going to make it worse on another one and i think at the moment we have an intuition that such results would be possible for pbs but it would be nice to to have them a little more formalized another drawback of course is whenever we move something to the protocol we add a bit more complexity and so this complexity may be justified if overall in the ecosystem we have a net reduction of the complexity but we have to be mindful that you know we that the protocol remains sound and so why not in protocol builders for instance so we can we could we could draw the line a little further and say well the builder role now is is also put in protocol searchers send their bids to the for their bundles and the proposals decide which bits to include some issues that i see with this is first the issue of bundle merging so you would have to make sure that the the bundles that are sent by the searchers don't conflict with one another if you do that by forcing the searchers to reveal the state accesses that they're going to use well that might already leak alpha but maybe a more serious problem is that you know over time searcher coordination they would figure out that it's just better to to to coordinate with one another and so they would just recreate a virtual builder role out of protocol and so so it's not clear that um enshrining a builder role in protocol would be would be so useful then all right and so yeah for the last let's say two or three minutes i wanted to do a more speculative part and i feel like i got a lot of answers from hasu's talk right before but i wanted to try and think through you know what will the market look like uh with this new under this new landscape there's a first market that i think is very interesting uh the market between users and searchers personally i would expect more user sophistication for the following reason you can think of the user utility and the searcher utility so if if only the transaction of a user goes through the user has a utility of 100 and the searcher has a utility of zero but if a searcher can profitably exploit or make use of the user transaction the searcher utility can grow to let's say a million dollars in that case it seems to me that there could be advantages deals struck between the user and the searcher i'm thinking for instance the ideas of cooperative game theory where the value that a coalition can achieve is often much greater than the sum of the parts of the coalition and now we have a very well developed crypto economical toolbox that maybe allows us to to create commitments from searchers and from users to to strike these deals in a in a very sound way this leads of course to the question of payment for order flow what would the searcher be willing to pay for hassou pointed out that it's very important to make sure that this order flow remains as decentralized as possible but it does feel like we can at least improve on the in terms of the the distribution of these of these costs i'm thinking point sensor of mist x which is a dex that makes use of this property and then there's a of course a market between searchers and builders there's still a trusted relationship there with the searchers providing their bundles to the builders we an argument for again why this might not be so useful to have in protocol is we can let the market figure out the risks that each party is willing to to bear and my intuition is that the market between searchers and builders is a thicker market than the market between uh builders and proposals so searchers they're very incentivized to compete on price and so if at any point there's a gap in this market they will feel it and on the other hand if the builders are unreliable i think it's it's in the domain of the searchers to to spin up their own or to find a way to to to recreate that entity maybe a piece of evidence for for this is this i really love this chart i think it's it's going to be in textbooks you know in a few years on because it really shows you how evolutionary the market for for block space is so on the x-axis is the value extracted uh by the by the miner so the value that the searcher provided to the to the miner given their bundle in percentage and you can clearly see this shift of the distribution to the right so as the market got more competitive researchers were forced to to give out more and more portions of the of the opportunities that they that they figured out and that's it for me thank you i think there is time for questions do you have a question sorry um hi ronnery um so my question is um on uh with um the the merge happening um if there is one entity that owns let's say 25 of the stake um how does that affect uh pbs because then they might be both the builder and proposer oh i see oh sorry and i just um if they know future blocks in or slots in the epoch um and then they can kind of do more sort of fancy arbitrage i see so yeah i guess functionally the role of validator and the role of builder is separate it's not clear that there is such profit to be made from vertical integration at that level that was actually something that um you know in in hasu's previous slide you you saw integration between users and searchers between searchers and builders not that much between builders and validators and i feel like maybe there's less interactions that are profitable but of course so you're mentioning the fact that validators know in advance the slots when where they are proposing in my opinion it's it's been a little difficult to figure out ways to really profit from that so of course knowing that you'll be the proposer in x slots is is useful but it doesn't give you that much of an edge over you know knowing that you are producing the next block or knowing that you have 10 blocks in a row i think it still depends on the on the market conditions one thing though is you know if you have a 35 percent staker which is also a builder um the question of builder centralization then becomes more relevant and so and then we have to think about you know mechanisms for censorship resistance for instance you talked about in mev context in in proof of work there being sort of a white list of minors i wonder if you see a space for effectively a white list of validators here potentially where they may even say i don't want to participate in mev and people who have a valuable transaction may send it to a private like memphis effectively run by those white listed entities so you're seeing a white list of validators who decide not to participate in mev extraction correct i've you know it's you could also decide not to participate in pbs and to just refuse every bundle that you see and just make your own block and really sit in the in the next block so you can always decide to opt out of of anything but the if you do want to opt in and this is the only way to to prevent economic centralization from from happening uh i think a white list won't give you that so yeah any other questions okay cool thank you so much thank you [Music] you 